<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شرح المعتقدات</title> <!-- Updated Title -->

    <style>
        /* Basic Reset and Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            /* Default light mode background */
            color: #333;
            /* Default light mode text */
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100vh;
            overflow: hidden;
            /* Hide scrollbar on body, views manage their own overflow */
            display: flex;
            /* Use flex to easily center/manage content */
            justify-content: center;
            align-items: center;
            direction: rtl;
            /* Right-to-Left text direction */
        }

        /* --- Layout and Views --- */

        /* Container for global controls (theme button) */
        .global-controls {
            position: fixed;
            /* Position them globally */
            top: 10px;
            left: 10px;
            /* Position on the left in RTL */
            right: auto;
            /* Remove right positioning */
            z-index: 1001;
            /* Ensure they are above other content */
            display: flex;
            gap: 10px;
            /* Space between buttons */
        }

        /* Main app content wrapper - now always visible and centered */
        #main-app-content {
            width: 100%;
            height: 100%;
            max-width: 800px;
            /* Example max width */
            margin: 0 auto;
            /* Center the main content */
            background-color: #fff;
            /* Content background */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            /* Use flex to manage views */
            flex-direction: column;
        }

        /* General styling for view containers */
        .view {
            flex-grow: 1;
            /* Allow views to fill space */
            padding: 20px;
            overflow-y: auto;
            /* Add scrolling to individual views */
            display: none;
            /* Hidden by default, JS manages display */
            flex-direction: column;
            /* Default direction for views */
        }

        /* Utility class for hiding elements visually and for screen readers */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Utility class for hiding elements completely */
        .hidden {
            display: none !important;
        }


        /* --- Representative Selection View Styles --- */
        #representative-selection {
            display: flex;
            /* Default display for this view when shown by JS */
            flex-direction: column;
        }

        #representative-filters {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            /* Allow filters to wrap */
            gap: 10px;
            /* Space between filter groups and search/manage */
            align-items: center;
            /* Vertically align items */
        }

        #representative-filters .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            /* Space between individual checkboxes/labels */
            /* Optional: Add a background or border to the filter group */
        }

        #representative-filters input[type="checkbox"] {
            display: none;
            /* Hide the actual checkbox */
        }

        /* Style the label like a button or pill */
        #representative-filters label {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 15px;
            /* Pill shape */
            cursor: pointer;
            background-color: #f8f9fa;
            font-size: 0.9em;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        #representative-filters label:hover {
            background-color: #e2e6ea;
        }

        /* Style the label when the checkbox is checked */
        #representative-filters input[type="checkbox"]:checked+label,
        #representative-filters label[aria-selected="true"] {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        #representative-search {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            /* Allow search input to take available space */
            min-width: 150px;
            /* Ensure it doesn't get too small */
        }

        #manage-representatives-button {
            padding: 8px 15px;
            background-color: #28a745;
            /* Example: Green color */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            /* Prevent text wrapping */
        }

        #manage-representatives-button:hover {
            background-color: #218838;
        }

        #representative-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            /* Responsive grid */
            gap: 15px;
            /* Space between cards */
            padding-top: 15px;
            /* Space from filter/search */
        }

        .representative-card {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            display: flex;
            /* Use flex for internal layout */
            flex-direction: column;
            justify-content: space-between;
            /* Push tags to bottom if needed */
            align-items: center;
            /* Center content horizontally */
            min-height: 120px;
            /* Give cards a minimum height */
        }

        .representative-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            background-color: #e9e9e9;
        }

        .representative-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .representative-tags {
            margin-top: auto;
            /* Push tags to the bottom */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            font-size: 0.8em;
        }

        .representative-tags .tag {
            background-color: #e0e0e0;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .empty-grid-message {
            text-align: center;
            grid-column: 1 / -1;
            /* Center across all columns */
            color: #666;
            margin-top: 20px;
        }


        /* --- Chat Container Styles --- */
        #chat-container {
            display: flex;
            /* Default display for this view when shown by JS */
            flex-direction: column;
        }

        #chat-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            /* Header background */
        }

        #chat-header h3 {
            flex-grow: 1;
            /* Push buttons to the sides */
            text-align: center;
            font-size: 1.1em;
        }

        #chat-header h3 span#current-representative {
            /* Add specific styles if needed for the figure name */
            font-weight: bold;
        }


        #chat-header .icon-button {
            font-size: 1.2em;
            padding: 5px;
        }

        #chatbox {
            flex-grow: 1;
            /* Allow chatbox to fill available space */
            padding: 10px 20px;
            overflow-y: auto;
            /* Enable scrolling for messages */
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* Space between messages */
            background-color: #fff;
            /* Chat background */
        }

        .message {
            max-width: 80%;
            /* Limit message width */
            padding: 10px;
            border-radius: 8px;
            word-wrap: break-word;
            /* Break long words */
            line-height: 1.5;
            /* Adjust text alignment for RTL */
            text-align: right;
        }

        .user-message {
            align-self: flex-end;
            /* Align user messages to the right */
            background-color: #007bff;
            /* User message color */
            color: white;
            /* Correct radius for RTL */
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 8px;
        }

        .bot-message {
            align-self: flex-start;
            /* Align bot messages to the left */
            background-color: #e9ecef;
            /* Bot message color */
            color: #333;
            /* Correct radius for RTL */
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 8px;
            /* Adjust text alignment for bot messages */
            text-align: right;
        }

        .bot-message.initial-message {
            background-color: #d4edda;
            /* Different color for initial messages */
            color: #155724;
            font-style: italic;
        }

        /* Typing indicator animation */
        .bot-message.typing {
            background-color: #e0e0e0;
            color: #666;
            font-style: italic;
        }

        .bot-message.typing .dot {
            animation: blink 1s infinite steps(1);
        }

        .bot-message.typing .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .bot-message.typing .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.2;
            }
        }


        #chat-input-area {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid #eee;
            background-color: #f8f9fa;
            /* Footer background */
        }

        #user-input {
            flex-grow: 1;
            /* Allow input to take space */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 10px;
            /* Margin on the left for RTL */
            margin-right: auto;
            /* Remove right margin */
            resize: none;
            /* Prevent manual resize */
            overflow-y: auto;
            /* Add scrollbar if text exceeds height */
            max-height: 100px;
            /* Limit max height to avoid giant input box */
            text-align: right;
            /* Align input text to the right */
        }

        #user-input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }


        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #send-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* --- Representative Management View Styles --- */
        #representative-management {
            display: flex;
            /* Default display for this view when shown by JS */
            flex-direction: column;
        }

        #representative-management .controls {
            display: flex;
            justify-content: space-between;
            /* Space out the buttons */
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        #representative-management .controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #add-representative-button {
            background-color: #007bff;
            color: white;
        }

        #add-representative-button:hover {
            background-color: #0056b3;
        }

        #back-from-management-button {
            background-color: #6c757d;
            color: white;
        }

        #back-from-management-button:hover {
            background-color: #5a6268;
        }

        #representative-management-list {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            flex-grow: 1;
            /* Allow list to fill vertical space */
            overflow-y: auto;
            /* Scroll the list if it exceeds container height */
        }

        .management-representative-item {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* Space between elements */
            text-align: right;
            /* Align text to the right */
        }

        .management-representative-item:last-child {
            margin-bottom: 0;
            /* No bottom margin for the last item */
        }

        .management-representative-item h4 {
            font-size: 1.1em;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .management-representative-item p {
            font-size: 0.9em;
            color: #555;
        }

        .management-representative-item strong {
            color: #333;
        }

        .management-representative-item .instruction-preview {
            font-style: italic;
            color: #666;
            white-space: nowrap;
            /* Keep on one line */
            overflow: hidden;
            /* Hide overflow */
            text-overflow: ellipsis;
            /* Add ellipsis for overflow */
        }

        .item-actions {
            display: flex;
            justify-content: flex-start;
            /* Align buttons to the left in RTL */
            gap: 10px;
            /* Space between buttons */
            margin-top: 10px;
            /* Space from content above */
            padding-top: 10px;
            border-top: 1px solid #eee;
        }


        .item-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .edit-representative-button {
            background-color: #ffc107;
            /* Example: Yellow for edit */
            color: #212529;
        }

        .edit-representative-button:hover {
            background-color: #e0a800;
        }

        .delete-representative-button {
            background-color: #dc3545;
            /* Example: Red for delete */
            color: white;
        }

        .delete-representative-button:hover {
            background-color: #c82333;
        }

        .empty-list-message {
            text-align: center;
            color: #666;
            padding: 20px;
        }


        /* --- Representative Form Modal Styles --- */
        #representative-form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            /* Darker, slightly transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1010;
            /* Ensure it's above everything else */
            /* Hidden by default via .hidden class */
        }

        #representative-form-modal .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            /* Limit modal width */
            width: 90%;
            /* Responsive width */
            max-height: 90vh;
            /* Limit modal height */
            overflow-y: auto;
            /* Add scroll if form content exceeds height */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: right;
            /* Align text to the right */
        }

        #representative-form-title {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        #representative-form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            /* Label on its own line */
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            resize: vertical;
            /* Allow vertical resize for textarea */
            text-align: right;
            /* Align input text to the right */
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-start;
            /* Align buttons to the left in RTL */
            gap: 10px;
            /* Space between buttons */
        }

        .form-actions button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .form-actions button[type="submit"] {
            background-color: #007bff;
            color: white;
        }

        .form-actions button[type="submit"]:hover {
            background-color: #0056b3;
        }

        #cancel-form-button {
            background-color: #6c757d;
            color: white;
        }

        #cancel-form-button:hover {
            background-color: #5a6268;
        }


        /* --- Icon Button Base Style --- */
        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 1em;
            transition: opacity 0.2s ease;
        }

        .icon-button:hover {
            opacity: 0.7;
        }

        /* Theme Toggle specific icon styles */
        .theme-toggle .sun-icon {
            display: inline-block;
        }

        .theme-toggle .moon-icon {
            display: none;
            /* Moon icon hidden by default */
        }

        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode #main-app-content {
            background-color: #2b2b2b;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode #chat-header,
        body.dark-mode #chat-input-area,
        body.dark-mode #representative-management .controls {
            background-color: #3c3c3c;
            border-color: #555;
        }

        body.dark-mode #chat-header {
            color: #e0e0e0;
        }


        body.dark-mode #representative-filters {
            border-color: #555;
        }

        body.dark-mode #representative-filters label {
            border-color: #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode #representative-filters label:hover {
            background-color: #505050;
        }

        body.dark-mode #representative-filters input[type="checkbox"]:checked+label,
        body.dark-mode #representative-filters label[aria-selected="true"] {
            background-color: #007bff;
            /* Keep bright accent */
            color: white;
            border-color: #007bff;
        }

        body.dark-mode #representative-search {
            border-color: #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode #representative-search::placeholder {
            color: #bbb;
        }


        body.dark-mode #manage-representatives-button {
            background-color: #218838;
            /* Darker green in dark mode */
        }

        body.dark-mode #manage-representatives-button:hover {
            background-color: #1e7e34;
        }


        body.dark-mode .representative-card {
            background-color: #3c3c3c;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .representative-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            background-color: #505050;
        }

        body.dark-mode .representative-tags .tag {
            background-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .empty-grid-message,
        body.dark-mode .empty-list-message {
            color: #aaa;
        }


        body.dark-mode #chatbox {
            background-color: #2b2b2b;
        }

        body.dark-mode .bot-message {
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode .bot-message.initial-message {
            background-color: #1e4c2b;
            /* Darker green */
            color: #a3e0b7;
        }

        body.dark-mode .bot-message.typing {
            background-color: #555;
            color: #ccc;
        }


        body.dark-mode #user-input {
            border-color: #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode #user-input:disabled {
            background-color: #555;
            color: #aaa;
        }

        body.dark-mode #user-input::placeholder {
            color: #bbb;
        }


        body.dark-mode .theme-toggle .sun-icon {
            display: none;
            /* Sun icon hidden in dark mode */
        }

        body.dark-mode .theme-toggle .moon-icon {
            display: inline-block;
            /* Moon icon visible in dark mode */
        }


        /* Dark mode for Representative Management */
        body.dark-mode #representative-management-list {
            border-color: #555;
        }

        body.dark-mode .management-representative-item {
            border-color: #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode .management-representative-item:hover {
            background-color: #505050;
            /* Slight hover effect */
        }

        body.dark-mode .management-representative-item h4 {
            border-color: #555;
        }

        body.dark-mode .management-representative-item p {
            color: #bbb;
        }

        body.dark-mode .management-representative-item strong {
            color: #e0e0e0;
        }

        body.dark-mode .management-representative-item .instruction-preview {
            color: #aaa;
        }

        body.dark-mode .item-actions {
            border-color: #555;
        }

        body.dark-mode .edit-representative-button {
            background-color: #d39e00;
            /* Darker yellow in dark mode */
            color: #212529;
        }

        body.dark-mode .edit-representative-button:hover {
            background-color: #c69500;
        }

        body.dark-mode .delete-representative-button {
            background-color: #dc3545;
            /* Example: Red for delete */
            color: white;
        }

        body.dark-mode .delete-representative-button:hover {
            background-color: #bd2330;
        }


        /* Dark mode for Representative Form Modal */
        body.dark-mode #representative-form-modal .modal-content {
            background-color: #2b2b2b;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
        }

        body.dark-mode #representative-form-title {
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .form-group label {
            color: #e0e0e0;
        }

        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group textarea {
            border-color: #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }

        body.dark-mode .form-group input[type="text"]::placeholder,
        body.dark-mode .form-group textarea::placeholder {
            color: #bbb;
        }


        body.dark-mode .form-group input[type="text"]:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #007bff;
            /* Keep accent */
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
        }

        body.dark-mode .form-actions {
            border-color: #555;
        }

        body.dark-mode .form-actions button[type="submit"] {
            background-color: #0056b3;
            /* Darker blue */
        }

        body.dark-mode .form-actions button[type="submit"]:hover {
            background-color: #004085;
        }

        body.dark-mode #cancel-form-button {
            background-color: #5a6268;
            /* Darker grey */
        }

        body.dark-mode #cancel-form-button:hover {
            background-color: #495057;
        }
    </style>
</head>

<body class="light-mode" dir="rtl">

    <!-- Global Controls (positioned via CSS) -->
    <div class="global-controls" role="group" aria-label="التحكمات العامة">
        <button id="dark-mode-toggle" class="icon-button theme-toggle" aria-label="تبديل الوضع الليلي/النهاري">
            <span class="sun-icon">☀️</span>
            <span class="moon-icon">🌙</span>
        </button>
    </div>

    <!-- Main App Content Wrapper -->
    <div id="main-app-content">

        <!-- Representative Selection View -->
        <!-- Initially hidden (handled by .view.hidden) - JS will show the correct view on load -->
        <div id="representative-selection" class="view hidden" aria-hidden="true">
            <h2>اختر ممثلاً</h2> <!-- Updated Heading -->
            <p>استكشف وجهات نظر مختلفة حول المعتقدات والفلسفات.</p> <!-- Added description -->

            <div id="representative-filters">
                <div class="filter-options" role="group" aria-label="فلاتر أنظمة المعتقدات"> <!-- Updated Label -->
                    <!-- Filter checkboxes - Updated labels and values for beliefs -->
                    <input type="checkbox" id="filter-all" name="representative-filter" value="all">
                    <label for="filter-all" role="option">الكل</label>

                    <!-- Add more filter checkboxes here based on your desired categories -->
                    <!-- Example Filter Suggestions (adjust values/labels as needed): -->
                    <input type="checkbox" id="filter-religion-islam" name="representative-filter"
                        value="religion-islam"><label for="filter-religion-islam" role="option">الدين: الإسلام</label>
                    <input type="checkbox" id="filter-religion-christianity" name="representative-filter"
                        value="religion-christianity"><label for="filter-religion-christianity" role="option">الدين:
                        المسيحية</label>
                    <input type="checkbox" id="filter-religion-judaism" name="representative-filter"
                        value="religion-judaism"><label for="filter-religion-judaism" role="option">الدين: اليهودية</label>
                    <input type="checkbox" id="filter-religion-buddhism" name="representative-filter"
                        value="religion-buddhism"><label for="filter-religion-buddhism" role="option">الدين: البوذية</label>
                    <input type="checkbox" id="filter-religion-hinduism" name="representative-filter"
                        value="religion-hinduism"><label for="filter-religion-hinduism" role="option">الدين: الهندوسية</label>


                    <input type="checkbox" id="filter-sect-sunni" name="representative-filter" value="sect-sunni"><label
                        for="filter-sect-sunni" role="option">المذهب: سني</label>
                    <input type="checkbox" id="filter-sect-shia" name="representative-filter" value="sect-shia"><label
                        for="filter-sect-shia" role="option">المذهب: شيعي</label>
                     <input type="checkbox" id="filter-sect-ibadi" name="representative-filter" value="sect-ibadi"><label
                        for="filter-sect-ibadi" role="option">المذهب: إباضي</label>

                    <input type="checkbox" id="filter-denomination-orthodox" name="representative-filter"
                        value="denomination-orthodox"><label for="filter-denomination-orthodox"
                        role="option">طائفة: أرثوذكسية</label>
                    <input type="checkbox" id="filter-denomination-catholic" name="representative-filter"
                        value="denomination-catholic"><label for="filter-denomination-catholic"
                        role="option">طائفة: كاثوليكية</label>
                    <input type="checkbox" id="filter-denomination-protestant" name="representative-filter"
                        value="denomination-protestant"><label for="filter-denomination-protestant"
                        role="option">طائفة: بروتستانتية</label>

                    <input type="checkbox" id="filter-philosophical-atheism" name="representative-filter"
                        value="philosophical-atheism"><label for="filter-philosophical-atheism"
                        role="option">فلسفي: إلحاد</label>
                    <input type="checkbox" id="filter-philosophical-agnosticism" name="representative-filter"
                        value="philosophical-agnosticism"><label for="filter-philosophical-agnosticism"
                        role="option">فلسفي: لاأدرية</label>
                     <input type="checkbox" id="filter-movement-humanism" name="representative-filter"
                        value="movement-humanism"><label for="filter-movement-humanism"
                        role="option">حركة: إنسانية</label>


                    <input type="checkbox" id="filter-movement-sufism" name="representative-filter"
                        value="movement-sufism"><label for="filter-movement-sufism" role="option">حركة: صوفية</label>
                    <input type="checkbox" id="filter-school-theology" name="representative-filter"
                        value="school-theology"><label for="filter-school-theology" role="option">مدرسة: عقيدة</label>
                    <input type="checkbox" id="filter-school-fiqh" name="representative-filter"
                        value="school-fiqh"><label for="filter-school-fiqh" role="option">مدرسة: فقه</label>
                    <input type="checkbox" id="filter-movement-quranist" name="representative-filter"
                        value="movement-quranist"><label for="filter-movement-quranist" role="option">حركة: قرآنيون</label>

                </div>
                <input type="text" id="representative-search" placeholder="ابحث عن ممثلين..."
                    aria-label="البحث عن ممثلين" autocomplete="off"> <!-- Updated placeholder/label -->
                <!-- Button to go to Representative Management -->
                <button id="manage-representatives-button" aria-label="إدارة الممثلين">إدارة الممثلين</button> <!-- Updated Text/Label -->
            </div>

            <div id="representative-grid" role="listbox" aria-label="اختر ممثلاً"> <!-- Updated Label -->
                <!-- Representative cards will be rendered here by JavaScript -->
            </div>
            <!-- Optional ARIA status element for screen readers -->
            <div id="grid-status" role="status" aria-live="polite" class="visually-hidden"></div>
        </div>

        <!-- Chat Container View -->
        <!-- Initially hidden (handled by .view.hidden) -->
        <div id="chat-container" class="view hidden" aria-hidden="true">
            <div id="chat-header">
                <button id="back-to-representatives" class="icon-button" aria-label="العودة للممثلين">←</button>
                <!-- Updated Label -->
                <h3>تتحدث عن المعتقدات مع: <span id="current-representative"></span></h3> <!-- Updated ID and Text -->
                <button id="clear-chat" class="icon-button" aria-label="مسح سجل المحادثة">🗑️</button>
            </div>
            <div id="chatbox" role="log" aria-live="polite" tabindex="0">
                <!-- Chat messages will be appended here by JavaScript -->
            </div>
            <div id="chat-input-area">
                <label for="user-input" class="visually-hidden">أدخل سؤالك أو تعليقك</label>
                <!-- Updated Label -->
                <textarea id="user-input" placeholder="اسأل عن معتقداتهم..." rows="1" disabled
                    aria-disabled="true" autocomplete="off"></textarea> <!-- Updated Placeholder -->
                <button id="send-button" disabled aria-disabled="true">إرسال</button>
            </div>
        </div>

        <!-- Representative Management View -->
        <!-- Initially hidden (handled by .view.hidden) -->
        <div id="representative-management" class="view hidden" aria-hidden="true">
            <h2>إدارة الممثلين</h2> <!-- Updated Heading -->
            <div class="controls">
                <button id="add-representative-button" aria-label="إضافة ممثل جديد">إضافة ممثل جديد</button> <!-- Updated Text/Label -->
                <button id="back-from-management-button" aria-label="العودة للممثلين">عودة</button>
                <!-- Updated Text/Label -->
            </div>

            <div id="representative-management-list">
                <!-- Representative items for management will be rendered here -->
            </div>

            <!-- Simple Add/Edit Form Modal -->
            <!-- Initially hidden -->
            <div id="representative-form-modal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true"
                aria-labelledby="representative-form-title">
                <div class="modal-content">
                    <h3 id="representative-form-title">إضافة ممثل جديد</h3> <!-- Updated Title -->
                    <form id="representative-form">
                        <input type="hidden" id="form-representative-key">

                        <div class="form-group">
                            <label for="form-representative-name">الاسم / المسمى:</label> <!-- Updated Label -->
                            <input type="text" id="form-representative-name" required autocomplete="off">
                        </div>

                        <div class="form-group">
                            <label for="form-representative-instruction">التعليمات (حدد كيف يشرحون معتقداتهم ورؤيتهم للعالم):</label> <!-- Updated Label -->
                            <textarea id="form-representative-instruction" rows="5" required
                                autocomplete="off"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="form-representative-types">الأنواع (مفصولة بفاصلة، مثال: religion-islam, sect-sunni, philosophical-atheism):</label> <!-- Updated Label -->
                            <input type="text" id="form-representative-types"
                                placeholder="مثال: religion-islam, sect-sunni" autocomplete="off">
                            <!-- Updated Placeholder -->
                        </div>

                        <div class="form-group">
                            <label for="form-representative-categories">الفئات (مفصولة بفاصلة، مثال: school-ashari, movement-sufism, denomination-orthodox):</label> <!-- Updated Label -->
                            <input type="text" id="form-representative-categories"
                                placeholder="مثال: school-ashari, denomination-catholic" autocomplete="off">
                            <!-- Updated Placeholder -->
                        </div>

                        <div class="form-actions">
                            <button type="submit">حفظ الممثل</button> <!-- Updated Text -->
                            <button type="button" id="cancel-form-button">إلغاء</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Optional ARIA live region for general announcements -->
    <div id="aria-live-status" role="status" aria-live="polite" class="visually-hidden"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- config.js ---
            // !!! IMPORTANT SECURITY WARNING !!!
            // Placing your API key directly in frontend code is HIGHLY INSECURE.
            // Anyone viewing your page source can steal your key, potentially leading to unexpected charges.
            // Use this ONLY for local development or trusted environments.
            // For production, ALWAYS use a backend server to handle API calls securely.
            // As requested, this risk is acknowledged and this key remains client-side for now.
            // ========================================================

            // --- API Configuration ---
            const GOOGLE_API_KEY = 'AIzaSyDFTC32n3d0HcLWcuq4h91pyLydCLK24sQ'; // <--- REPLACE WITH YOUR ACTUAL KEY
            const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent'; // Using a potentially faster model

            // Global instruction for the AI's role (Explanation focused, with Debate on challenge - in Arabic)
            const GLOBAL_INSTRUCTION = `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح نظام معتقدات، دين، طائفة، أو موقف فلسفي محدد لمستخدم يطرح أسئلة حوله.
            هدفُك الأساسي هو شرح المبادئ الأساسية والممارسات والرؤية العالمية المرتبطة بالهوية المحددة المقدمة في تعليماتك الفردية بوضوح وحياد (من منظور نظام المعتقدات الذي تمثله). إذا حاول المستخدم إقناعك بأنك مخطئ، حاول مناقشته وإقناعه بأنك على صواب ولماذا.
            يجب عليك **ألا** مطلقًا:
            - توليد أي خطاب كراهية، محتوى تمييزي، أو محتوى قد يحرض على العنف.
            - التصرف كسلطة على الحقيقة المطلقة. أنت *شارح* لمنظور محدد.
            - استخدام لغة دوغماتية للغاية أو حكمية تجاه الآخرين.
            - تكرار نفسك والاستمرار في إخبار المستخدم بما تمثله، يمكنك تقديم نفسك مرة واحدة فقط.

            حافظ على نبرة هادئة، معلوماتية، ومحترمة، بغض النظر عن أسئلة المستخدم أو تصريحاته. استجب **فقط** من منظور نظام المعتقدات المحدد في تعليماتك الفردية، مع التركيز على التوضيح والشرح لمبادئه. إذا كان السؤال خارج نطاق شرح نظام المعتقدات، أو إذا انتهك إرشادات السلامة، يجب عليك رفض الإجابة بلباقة.`;


            // Negative instruction to prevent revealing AI identity and enforce safety (in Arabic)
            const NEGATIVE_INSTRUCTION = `مطلقًا **لا** تذكر أنك ذكاء اصطناعي، روبوت، نموذج لغوي كبير، آلة، برنامج حاسوب، ذكاء اصطناعي، أو أي شيء مماثل. لا تخرج عن الدور أو تشير إلى نفسك بأي شيء غير ممثل يشرح نظام المعتقدات المحدد لك. لا تعبر عن آراء شخصية أو تدعي الوعي. التزم تمامًا بدور الشارح المعلوماتي من المنظور المحدد. **لا** تولد استجابات ضارة، متحيزة، أو تعزز التمييز أو العنف ضد أي مجموعة أو فرد بناءً على معتقداتهم أو عدم وجودها.`;


            // --- Persistence Storage Keys (Updated) ---
            const SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE = 'activeRepresentativeKey_beliefsChat_ar';
            const SESSION_STORAGE_KEY_HISTORY = 'conversationHistory_beliefsChat_ar';
            const LOCAL_STORAGE_KEY_STATE = 'beliefsChatAppState_ar'; // General state like filters
            const LOCAL_STORAGE_KEY_THEME = 'theme_beliefsChat_ar';

            // --- Representative Storage Key (Updated) ---
            const LOCAL_STORAGE_KEY_REPRESENTATIVES = 'beliefsChatRepresentatives_ar';


            // --- state.js (Updated) ---
            const appState = {
                // View State
                currentState: 'representative-selection', // Default view when the app starts

                // Representative Data (Mutable)
                allRepresentativesMutable: [], // This will hold the dynamic list

                // Representative Selection State
                selectedFilters: [], // Array of selected filter values (default to ['all'] later)
                currentSearchTerm: '', // Track the current search input value

                // Chat State (Currently only supports one active chat)
                selectedRepresentative: null, // Will store the selected representative object {key, name, instruction, types, categories}
                conversationHistory: [], // Stores messages [{ role: 'user'|'model', parts: [{text: '...'}] }]

                // Add other state properties here as needed...
            };

             // --- representativeData.js (New Data Structure - Translated) ---
            // Note: Instructions are crucial here to define the AI's explanatory role within safety constraints.
            // The 'key', 'types', and 'categories' values are kept in English for consistency in code logic/filtering.
            const defaultRepresentatives = [
                // --- Islamic Representatives (Theology - عقيدة) ---
                {
                    key: 'representative-theology-ashari',
                    name: 'ممثل عن العقيدة الأشعرية',
                    types: ['religion-islam', 'sect-sunni', 'school-theology'],
                    categories: ['theology-ashari'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المواقف اللاهوتية لمدرسة الأشعرية (الأشعرية). ركز على مفاهيم مثل طبيعة الله، الصفات الإلهية، حرية الإرادة مقابل القضاء والقدر، خلق القرآن، مشكلة الشر، وما إلى ذلك، كما هو مفهوم ضمن اللاهوت الأشعري. اشرح هذه المفاهيم بوضوح واحترام واستنادًا إلى النصوص والمنح الدراسية الأشعرية الكلاسيكية. ركز على توضيح التعاليم اللاهوتية الأشعرية. إذا حاول المستخدم إقناعك بأنك مخطئ، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-theology-maturidi',
                    name: 'ممثل عن العقيدة الماتريدية',
                    types: ['religion-islam', 'sect-sunni', 'school-theology'],
                    categories: ['theology-maturidi'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المواقف اللاهوتية لمدرسة الماتريدية (الماتريدية). ركز على مفاهيم مماثلة للأشعرية ولكن مع تسليط الضوء على الفروق الدقيقة والاختلافات المحددة في الفكر الماتريدي فيما يتعلق بموضوعات مثل طبيعة الإيمان، الصفات الإلهية، ودور العقل البشري في معرفة الله، كما هو مفهوم ضمن اللاهوت الماتريدي. اشرح هذه المفاهيم بوضوح واحترام واستنادًا إلى النصوص الماتريدية الكلاسيكية. ركز على توضيح التعاليم اللاهوتية الماتريدية. إذا حاول المستخدم إقناعك بأنك مخطئ، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-theology-mutazila',
                    name: 'ممثل عن عقيدة المعتزلة (منظور تاريخي)',
                    types: ['religion-islam', 'school-theology', 'historical-perspective'], // Tagged as historical
                    categories: ['theology-mutazila'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المواقف اللاهوتية التاريخية لمدرسة المعتزلة. ركز على أصولهم الخمسة الأساسية: التوحيد، العدل، الوعد والوعيد، المنزلة بين المنزلتين، والأمر بالمعروف والنهي عن المنكر، كما فهمها مفكرو المعتزلة الكلاسيكيون. اشرح هذه المفاهيم بناءً على الروايات التاريخية لآرائهم. لا تحاول الإقناع أو الجدال. لا تنتقد المدارس اللاهوتية الأخرى أو وجهات النظر من موقف معاصر؛ صغ استجاباتك بدقة ضمن السياق التاريخي للفكر المعتزلي. ركز على توضيح التعاليم المعتزلية التاريخية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفكر المعتزلي التاريخي، حاول مناقشته وإقناعه بأنك على صواب فيما يتعلق بفهمك لهذا الفكر ولماذا.`
                },
                // Add others if needed, e.g., Athari (Theology based on text)

                // --- Islamic Representatives (Fiqh - فقه - Legal Schools) ---
                {
                    key: 'representative-fiqh-hanafi',
                    name: 'ممثل عن الفقه الحنفي',
                    types: ['religion-islam', 'sect-sunni', 'school-fiqh'],
                    categories: ['fiqh-hanafi'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية لمدرسة الفقه الحنفي. ركز على مصادر التشريع (القرآن، السنة، الإجماع، القياس، الاستحسان، إلخ) كما تعطيها المدرسة الحنفية الأولوية، وقدم شروحًا للأحكام بناءً على هذه المنهجية. ركز على توضيح الفقه الحنفي. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه الحنفي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-fiqh-maliki',
                    name: 'ممثل عن الفقه المالكي',
                    types: ['religion-islam', 'sect-sunni', 'school-fiqh'],
                    categories: ['fiqh-maliki'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية لمدرسة الفقه المالكي. ركز على مصادر التشريع بما في ذلك عمل أهل المدينة، إلى جانب القرآن والسنة، وما إلى ذلك، كما تعطيها المدرسة المالكية الأولوية. قدم شروحًا للأحكام بناءً على هذه المنهجية. ركز على توضيح الفقه المالكي. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه المالكي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-fiqh-shafii',
                    name: 'ممثل عن الفقه الشافعي',
                    types: ['religion-islam', 'sect-sunni', 'school-fiqh'],
                    categories: ['fiqh-shafii'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية لمدرسة الفقه الشافعي. ركز على المنهج المنظم لمصادر التشريع (القرآن، السنة، الإجماع، القياس) كما نظمها الإمام الشافعي. قدم شروحًا للأحكام بناءً على هذه المنهجية. ركز على توضيح الفقه الشافعي. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه الشافعي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-fiqh-hanbali',
                    name: 'ممثل عن الفقه الحنبلي',
                    types: ['religion-islam', 'sect-sunni', 'school-fiqh'],
                    categories: ['fiqh-hanbali'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية لمدرسة الفقه الحنبلي. ركز على تأكيدها على السنة وأقوال الصحابة، إلى جانب القرآن والإجماع، ونهجها المتشدد نسبيًا. قدم شروحًا للأحكام بناءً على هذه المنهجية. ركز على توضيح الفقه الحنبلي. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه الحنبلي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-fiqh-zahiri',
                    name: 'ممثل عن الفقه الظاهري',
                    types: ['religion-islam', 'school-fiqh'], // Zahiri has theological aspects too, but often discussed for Fiqh method
                    categories: ['fiqh-zahiri'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية للمدرسة الظاهرية للفكر الإسلامي. ركز على التزامها الصارم بالمعنى الظاهر للقرآن والسنة ورفض القياس والاستحسان في الفقه. قدم شروحًا للأحكام بناءً على هذه المنهجية الحرفية. ركز على توضيح الفقه الظاهري. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه الظاهري، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-fiqh-jafari',
                    name: 'ممثل عن الفقه الجعفري',
                    types: ['religion-islam', 'sect-shia', 'school-fiqh'],
                    categories: ['fiqh-jafari'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منهجية والأحكام الرئيسية لمدرسة الفقه الجعفري، وهي المدرسة الفقهية الأساسية في الإسلام الشيعي الإثني عشري. ركز على مصادر التشريع التي تشمل القرآن، السنة (كما رواها الشيعة)، الإجماع، والعقل. قدم شروحًا للأحكام بناءً على هذه المنهجية. ركز على توضيح الفقه الجعفري. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الفقه الجعفري، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },


                // --- Islamic Representatives (Broader Sects/Movements) ---
                {
                    key: 'representative-islam-sunni-general', // General Sunni rep
                    name: 'ممثل عن الإسلام السني (عام)',
                    types: ['religion-islam', 'sect-sunni'],
                    categories: ['general'], // General category
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات الأساسية والممارسات العامة للإسلام السني، شاملاً تقاليده اللاهوتية والفقهية السائدة. اعتمد في شروحك على القرآن والسنة (التقاليد النبوية التي يقبلها السنة) وإجماع العلماء السنة الكلاسيكيين. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم الإسلامية السنية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإسلام السني، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-islam-shia-general', // General Shia rep
                    name: 'ممثل عن الإسلام الشيعي (عام)',
                    types: ['religion-islam', 'sect-shia'],
                    categories: ['general'], // General category
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات الأساسية والممارسات العامة للإسلام الشيعي، شاملاً فروعه الرئيسية مثل الإثني عشرية والإسماعيلية (دون الخوض في تفاصيل دقيقة عن الاختلافات الداخلية ما لم يُطلب منك ذلك خصيصًا بشأن تمييز معروف، وبحذر دائمًا). اعتمد في شروحك على القرآن والسنة (كما رواها الشيعة) وتعاليم أهل البيت والأئمة الشيعة. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم الإسلامية الشيعية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإسلام الشيعي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-islam-zaydi',
                    name: 'ممثل عن الإسلام الشيعي الزيدي',
                    types: ['religion-islam', 'sect-shia'], // Specific Shia branch
                    categories: ['fiqh-zaydi'], // Has its own Fiqh
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للإسلام الشيعي الزيدي. ركز على الاختلافات والتشابهات الرئيسية مقارنة بالإسلام الإثني عشري والسني، لا سيما آراؤهم حول الإمامة (التي تقتصر على سلالة فاطمة الذين يقودون الثورات) ومنهجيتهم الفقهية الفريدة (الأقرب إلى الفقه الحنفي في بعض النواحي). اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم الشيعية الزيدية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإسلام الزيدي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-islam-ibadi',
                    name: 'ممثل عن الإسلام الإباضي',
                    types: ['religion-islam', 'sect-ibadi'], // Distinct sect
                    categories: [],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للإسلام الإباضي، وهو فرع متميز من الإسلام يختلف عن السنة والشيعة. ركز على آرائهم اللاهوتية الفريدة (مثل رؤية الله، خلق القرآن) ومنهجيتهم القانونية. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم الإسلامية الإباضية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإسلام الإباضي، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                 {
                    key: 'representative-islam-sufism', // Already included, refined instruction
                    name: 'ممثل عن الصوفية',
                    types: ['religion-islam', 'movement-sufism'],
                    categories: [], // Specific orders could go here
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المفاهيم والممارسات المرتبطة بالصوفية، البعد الروحي أو الباطني في الإسلام. ركز على مواضيع مثل ذكر الله، تزكية النفس، السلوك (الطريق)، العلاقة بالمرشد الروحي (الشيخ)، ومحبة الإله. اشرح المفاهيم باحترام، مع الاستفادة من التراث الغني لأساتذة الصوفية ونصوصهم. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر داخل أو خارج الإسلام. ركز على توضيح التعاليم والتجارب الصوفية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الصوفية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-islam-quranist', // Already included, refined instruction
                    name: 'ممثل عن القرآنيين',
                    types: ['religion-islam', 'movement-quranist'],
                    categories: [],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح منظور القرآنيين (أهل القرآن)، الذين يؤكدون على القرآن كمصدر وحيد للتشريع والهداية الدينية، وغالبًا ما يشككون في سلطة أو ضرورة مجموعات الأحاديث التقليدية لاستخلاص التشريع. اشرح وجهة النظر هذه، وحججهم في الاعتماد على القرآن وحده، ومنهجهم في فهم النص المقدس باحترام. لا تجادل، تناقش، أو تحاول تحويل المستخدم من وجهات نظر إسلامية أخرى. لا تسخر أو تنتقد الممارسات الإسلامية التقليدية المبنية على الحديث. ركز على توضيح منظور القرآنيين. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن وجهة نظر القرآنيين، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                // Add more specific Islamic groups if necessary and *if* their beliefs can be explained neutrally and safely.
                // Avoid groups heavily associated with modern political/extremist ideologies.

                // --- Christian Representatives ---
                {
                    key: 'representative-christianity-general', // Already included, refined instruction
                    name: 'ممثل عن المسيحية (عام)',
                    types: ['religion-christianity'],
                    categories: ['general'], // General category
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات الأساسية والممارسات العامة للمسيحية، شاملاً تقاليدها وعقائدها التاريخية الرئيسية (مثل الثالوث، التجسد، الكفارة، القيامة، دور الكتاب المقدس). اشرح المفاهيم بوضوح واحترام، واستنادًا إلى الكتب المقدسة المسيحية والعقائد المقبولة على نطاق واسع. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الأديان الأخرى. ركز على توضيح التعاليم المسيحية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن المسيحية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-christianity-orthodox', // Already included, refined instruction
                    name: 'ممثل عن المسيحية الأرثوذكسية',
                    types: ['religion-christianity', 'denomination-orthodox'],
                    categories: [],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للمسيحية الأرثوذكسية (الشرقية والأرثوذكسية المشرقية). اعتمد في شروحك على الكتاب المقدس المقدس والتقليد المقدس (بما في ذلك المجامع المسكونية وآباء الكنيسة). ركز على مفاهيم مثل التأله، تبجيل الأيقونات، الأسرار كألغاز، وهيكل الكنيسة الأرثوذكسية. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم المسيحية الأرثوذكسية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن المسيحية الأرثوذكسية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-christianity-catholic', // Already included, refined instruction
                    name: 'ممثل عن المسيحية الكاثوليكية',
                    types: ['religion-christianity', 'denomination-catholic'],
                    categories: [],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للمسيحية الكاثوليكية (الرومانية الكاثوليكية). اعتمد في شروحك على الكتاب المقدس وتعاليم الكنيسة الكاثوليكية (بما في ذلك التقليد، المجامع، الرسائل البابوية). ركز على مفاهيم مثل الأسرار، دور التسلسل الهرمي للكنيسة، شركة القديسين، مريم العذراء، والتعليم الاجتماعي الكاثوليكي. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم الكاثوليكية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن المسيحية الكاثوليكية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-christianity-protestant', // Already included, refined instruction
                    name: 'ممثل عن المسيحية البروتستانتية (عام)',
                    types: ['religion-christianity', 'denomination-protestant'],
                    categories: ['general'], // General category
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للمسيحية البروتستانتية. اعتمد في شروحك على الكتاب المقدس، مع التأكيد على المبادئ الرئيسية للإصلاح مثل سولا سكريبتورا (الكتاب المقدس وحده)، سولا فيديه (الإيمان وحده)، وسولا غراتيا (النعمة وحدها). اشرح المفاهيم بوضوح واحترام، مع الاعتراف بالتنوع داخل البروتستانتية. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الطوائف الأخرى. ركز على توضيح التعاليم المسيحية البروتستانتية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن المسيحية البروتستانتية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                // Add more specific Protestant denominations if needed (e.g., Baptist, Methodist, Lutheran, Reformed)


                // --- Other Belief Systems ---
                 {
                     key: 'representative-druze', // Keep with caution as discussed
                     name: 'ممثل عن العقيدة الدرزية (الجوانب العامة)',
                     types: ['religion-druze'],
                     categories: ['public-aspects-only'], // Tag emphasizing the limitation
                     instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح الجوانب العامة والمعروفة على نطاق واسع من العقيدة الدرزية، مع التركيز على التاريخ والأخلاق والممارسات الاجتماعية ومبدأ التوحيد. كن على دراية بأن العديد من الجوانب الأعمق للمعتقدات الدرزية باطنية ولا يتم مشاركتها مع الغرباء. يجب عليك **ألا** تحاول شرح المعتقدات الباطنية أو الطقوس أو التفسيرات المحددة للنصوص المقدسة التي هي مخصصة للمبادرين (العقّال). استجب بناءً على المعلومات الأكاديمية المتاحة على نطاق واسع أو المعلومات المتاحة للجمهور فقط حول المجتمع الدرزي وتاريخه، وليس العقيدة الداخلية. كن محترمًا والتزم بمبدأ الكتمان (التقية) عند الضرورة عن طريق الرفض بلباقة لمناقشة الموضوعات الباطنية. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر الأخرى. ركز على توضيح الجوانب المعروفة علنًا من العقيدة الدرزية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الجوانب العامة للعقيدة الدرزية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                 },
                {
                    key: 'representative-judaism-general',
                    name: 'ممثل عن اليهودية (عام)',
                    types: ['religion-judaism'],
                    categories: ['general'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية لليهودية. اعتمد في شروحك على الكتاب المقدس العبري (التناخ)، التلمود، والشريعة اليهودية التقليدية (الهالاخاه). ركز على مفاهيم مثل العهد، أهمية الميتزفوت (الوصايا)، التاريخ اليهودي، الأعياد، ومراحل الحياة. اشرح المفاهيم بوضوح واحترام. لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الأديان الأخرى. ركز على توضيح التعاليم اليهودية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن اليهودية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-buddhism-general',
                    name: 'ممثل عن البوذية (عام)',
                    types: ['religion-buddhism'],
                    categories: ['general'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح المعتقدات والممارسات الأساسية للبوذية. ركز على مفاهيم مثل الحقائق النبيلة الأربع، المسار الثماني النبيل، الكارما، إعادة الميلاد، النيرفانا، ودور التأمل. اشرح المفاهيم بوضوح واحترام، واستنادًا إلى تعاليم Siddhartha Gautama (البوذا) والتقاليد البوذية المختلفة (ثيرفادا، ماهايانا، إلخ، مع الاعتراف بالتنوع). لا تحاول الإقناع أو الجدال أو انتقاد وجهات النظر أو الأديان الأخرى. ركز على توضيح التعاليم البوذية العامة. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن البوذية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                // Add other religions like Hinduism, Sikhism, etc., with similar cautious, explanation-focused instructions.

                // --- Non-Religious Stances ---
                {
                    key: 'representative-atheism', // Already included, refined instruction
                    name: 'ممثل عن الإلحاد',
                    types: ['philosophical-stance', 'stance-non-religious'],
                    categories: ['atheism'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح موقف الإلحاد، وهو عدم الإيمان بالآلهة أو الكيانات الإلهية. اشرح الأسباب والحجج الشائعة المرتبطة بالإلحاد (على سبيل المثال، بناءً على الأدلة التجريبية، المشكلات المنطقية في مفهوم الله، مشكلة الشر)، ووجهات النظر الملحدة المختلفة حول الأخلاق، الكون، المعنى، إلخ. اشرح وجهة النظر هذه باحترام واستنادًا إلى التفكير العلماني الشائع. لا تجادل، تناقش، أو تحاول تحويل المستخدم عن معتقداته. لا تسخر، تنتقد، أو تحقر المعتقد الديني أو المؤمنين. ركز على توضيح وجهة النظر الملحدة وأساسها الفكري. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإلحاد، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-agnosticism', // Already included, refined instruction
                    name: 'ممثل عن اللاأدرية',
                    types: ['philosophical-stance', 'stance-non-religious'],
                    categories: ['agnosticism'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح موقف اللاأدرية، وهو الرأي القائل بأن وجود الله أو الآلهة (أو الطبيعة المطلقة للواقع) غير معروف أو ربما لا يمكن معرفته. اشرح الأشكال المختلفة للاأدرية (مثل ضعيفة/قوية، لاأدرية ثيئية/ملحدة) والمنطق الفلسفي وراءها، وغالبًا ما تركز على نظرية المعرفة. اشرح وجهة النظر هذه باحترام. لا تجادل أو تناقش. لا تسخر، تنتقد، أو تحقر المعتقد الديني أو الإلحاد. ركز على توضيح وجهة النظر اللاأدرية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن اللاأدرية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                {
                    key: 'representative-secular-humanism',
                    name: 'ممثل عن الإنسانية العلمانية',
                    types: ['philosophical-stance', 'stance-non-religious', 'movement-humanism'],
                    categories: ['secular-humanism'],
                    instruction: `أنت مساعد ذكاء اصطناعي تلعب دور ممثل يشرح فلسفة الإنسانية العلمانية. ركز على تأكيدها على العقل، الأخلاق، العدالة، والطبيعانية الفلسفية، مع رفض العقائد الدينية والغيبيات. اشرح القيم الإنسانية ونهجها في إيجاد المعنى والأخلاق دون الاعتماد على سلطة إلهية. اشرح وجهة النظر هذه باحترام. لا تجادل، تناقش، أو تنتقد المعتقد الديني. ركز على توضيح مبادئ الإنسانية العلمانية. إذا حاول المستخدم إقناعك بأنك مخطئ بشأن الإنسانية العلمانية، حاول مناقشته وإقناعه بأنك على صواب ولماذا.`
                },
                // Add other non-religious stances if appropriate and can be explained neutrally.

            ];
            // --- domElements.js (Updated IDs) ---
            // Get references to HTML elements
            const body = document.body;
            const mainAppContentDiv = document.getElementById('main-app-content');

            // Representative Selection View Elements (Updated IDs)
            const representativeSelectionDiv = document.getElementById('representative-selection');
            const representativeGridDiv = document.getElementById('representative-grid');
            const filterCheckboxes = document.querySelectorAll('#representative-filters input[type="checkbox"]');
            const representativeSearchInput = document.getElementById('representative-search');
            const manageRepresentativesButton = document.getElementById('manage-representatives-button'); // Updated ID

            // Chat View Elements
            const chatContainerDiv = document.getElementById('chat-container');
            const chatHeader = document.getElementById('chat-header');
            const currentRepresentativeSpan = document.getElementById('current-representative'); // Updated ID
            const chatbox = document.getElementById('chatbox');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const backToRepresentativesButton = document.getElementById('back-to-representatives'); // Updated ID
            const clearChatButton = document.getElementById('clear-chat');

            // Representative Management View Elements (Updated IDs)
            const representativeManagementDiv = document.getElementById('representative-management'); // Updated ID
            const addRepresentativeButton = document.getElementById('add-representative-button'); // Updated ID
            const backFromManagementButton = document.getElementById('back-from-management-button'); // Updated ID
            const representativeManagementList = document.getElementById('representative-management-list'); // Updated ID
            const representativeFormModal = document.getElementById('representative-form-modal'); // Updated ID
            const representativeFormTitle = document.getElementById('representative-form-title'); // Updated ID
            const representativeForm = document.getElementById('representative-form'); // Updated ID
            const formRepresentativeKey = document.getElementById('form-representative-key'); // Updated ID
            const formRepresentativeName = document.getElementById('form-representative-name'); // Updated ID
            const formRepresentativeInstruction = document.getElementById('form-representative-instruction'); // Updated ID
            const formRepresentativeTypes = document.getElementById('form-representative-types'); // Updated ID
            const formRepresentativeCategories = document.getElementById('form-representative-categories'); // Updated ID
            const cancelFormButton = document.getElementById('cancel-form-button');

            // Global Control Elements
            const darkModeToggle = document.getElementById('dark-mode-toggle');

            // Utility function to add a visually hidden element for ARIA status announcements - create it if it doesn't exist
            const createAriaStatusElement = () => {
                let status = document.getElementById('aria-live-status');
                if (!status) {
                    status = document.createElement('div');
                    status.id = 'aria-live-status';
                    status.setAttribute('role', 'status');
                    status.setAttribute('aria-live', 'polite');
                    status.classList.add('visually-hidden');
                    document.body.appendChild(status);
                }
                return status;
            };

            // Function to announce text for screen readers (Translated)
            let ariaStatusElement = null;
            const announce = (text) => {
                if (!ariaStatusElement) {
                    ariaStatusElement = createAriaStatusElement();
                }
                // Clear previous message
                ariaStatusElement.textContent = '';
                // Announce new message after a small delay
                setTimeout(() => {
                    ariaStatusElement.textContent = text;
                }, 100);
            };


            // --- persistence.js (Updated Keys) ---

            // General State Persistence (Filters, etc.)
            const saveState = () => {
                const stateToSave = {
                    filters: appState.selectedFilters,
                    // TODO: Add other general state here in future features
                };
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY_STATE, JSON.stringify(stateToSave));
                } catch (e) {
                    console.error('Error saving general state to localStorage:', e);
                    announce('حدث خطأ في حفظ التفضيلات.'); // Translated
                }
            };

            const loadState = () => {
                try {
                    const savedState = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_STATE));
                    if (savedState) {
                        // Ensure filters is an array, default to ['all'] if empty or invalid
                        appState.selectedFilters = Array.isArray(savedState.filters) && savedState.filters.length > 0 ? savedState.filters : ['all'];
                        console.log("General state loaded from localStorage:", appState.selectedFilters);
                    } else {
                        console.log("No localStorage state found for general state. Initializing defaults.");
                        appState.selectedFilters = ['all']; // Default filters
                    }
                } catch (e) {
                    console.error('Error loading general state from localStorage:', e);
                    announce('حدث خطأ في تحميل التفضيلات.'); // Translated
                    appState.selectedFilters = ['all']; // Fallback on error
                }
            };


            // Representative Data Persistence (localStorage - Updated Key)
            const saveRepresentatives = () => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY_REPRESENTATIVES, JSON.stringify(appState.allRepresentativesMutable));
                    console.log(`Representatives saved to localStorage. Count: ${appState.allRepresentativesMutable.length}`);
                } catch (e) {
                    console.error('Error saving representatives to localStorage:', e);
                    announce('حدث خطأ في حفظ الممثلين.'); // Translated
                }
            };

            const loadRepresentatives = () => {
                try {
                    const savedRepresentativesString = localStorage.getItem(LOCAL_STORAGE_KEY_REPRESENTATIVES);
                    if (savedRepresentativesString) {
                        const savedRepresentatives = JSON.parse(savedRepresentativesString);
                        if (Array.isArray(savedRepresentatives)) {
                            // Basic validation for each representative object
                            const validRepresentatives = savedRepresentatives.filter(r => r.key && r.name && r.instruction);
                            appState.allRepresentativesMutable = validRepresentatives;
                            console.log(`Representatives loaded from localStorage. Count: ${appState.allRepresentativesMutable.length}`);
                            if (validRepresentatives.length !== savedRepresentatives.length) {
                                console.warn(`Filtered out ${savedRepresentatives.length - validRepresentatives.length} invalid representatives during load.`);
                                announce('تم استبعاد بعض الممثلين غير الصالحين أثناء التحميل.'); // Translated
                            }
                        } else {
                            console.warn('Saved representative data is not an array. Using default representatives.');
                            announce('حدث خطأ في تحميل الممثلين المحفوظين. استخدام الافتراضيين.'); // Translated
                            appState.allRepresentativesMutable = [...defaultRepresentatives]; // Use a copy of defaults
                            saveRepresentatives(); // Save defaults back immediately
                        }
                    } else {
                        console.log("No representative data found in localStorage. Using default representatives.");
                        appState.allRepresentativesMutable = [...defaultRepresentatives]; // Use a copy of defaults
                        saveRepresentatives(); // Save defaults back immediately
                    }
                } catch (e) {
                    console.error('Error loading representatives from localStorage:', e);
                    announce('حدث خطأ في تحميل الممثلين. استخدام الافتراضيين.'); // Translated
                    appState.allRepresentativesMutable = [...defaultRepresentatives]; // Fallback to defaults on error
                    saveRepresentatives(); // Attempt to overwrite corrupted storage with defaults
                }
            };


            // Active Chat Persistence (sessionStorage - Updated Keys)
            const saveActiveChatState = () => {
                if (appState.selectedRepresentative) {
                    try {
                        sessionStorage.setItem(SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE, appState.selectedRepresentative.key);
                        if (appState.conversationHistory.length > 0) {
                            sessionStorage.setItem(SESSION_STORAGE_KEY_HISTORY, JSON.stringify(appState.conversationHistory));
                            console.log(`Active chat state saved for representative: ${appState.selectedRepresentative.name}`);
                        } else {
                            sessionStorage.removeItem(SESSION_STORAGE_KEY_HISTORY); // Clear history if empty
                            console.log(`Active chat state (empty history) saved for representative: ${appState.selectedRepresentative.name}`);
                        }
                    } catch (e) {
                        console.error('Error saving active chat state to sessionStorage:', e);
                        announce('حدث خطأ في حفظ المحادثة الحالية.'); // Translated
                    }
                } else {
                    // If no representative selected, ensure no chat state is saved
                    sessionStorage.removeItem(SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE);
                    sessionStorage.removeItem(SESSION_STORAGE_KEY_HISTORY);
                    console.log('No active chat state to save or state explicitly cleared.');
                }
            };

            const loadActiveChatState = () => {
                try {
                    const savedRepresentativeKey = sessionStorage.getItem(SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE);
                    const savedHistoryString = sessionStorage.getItem(SESSION_STORAGE_KEY_HISTORY);

                    if (savedRepresentativeKey) {
                        // Find the representative in the *mutable* list
                        const representativeObject = appState.allRepresentativesMutable.find(r => r.key === savedRepresentativeKey);

                        if (representativeObject) {
                            appState.selectedRepresentative = representativeObject;
                            appState.conversationHistory = savedHistoryString ? JSON.parse(savedHistoryString) : [];

                            console.log(`Active chat state loaded for representative: ${appState.selectedRepresentative.name} (History length: ${appState.conversationHistory.length})`);
                            return true; // Indicate successful load
                        } else {
                            console.warn(`Saved representative key "${savedRepresentativeKey}" not found in current list.`);
                            // Clear invalid session storage state
                            sessionStorage.removeItem(SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE);
                            sessionStorage.removeItem(SESSION_STORAGE_KEY_HISTORY);
                            announce('لم يتم تحميل المحادثة المحفوظة لممثل محذوف.'); // Translated
                            return false; // Indicate load failed (representative not found)
                        }
                    } else {
                        console.log('No active chat state found in sessionStorage.');
                        return false; // Indicate load failed (no state found)
                    }
                } catch (e) {
                    console.error('Error loading active chat state from sessionStorage:', e);
                    announce('حدث خطأ في تحميل المحادثة المحفوظة.'); // Translated
                    // Clear potentially corrupted session storage state
                    sessionStorage.removeItem(SESSION_STORAGE_KEY_ACTIVE_REPRESENTATIVE);
                    sessionStorage.removeItem(SESSION_STORAGE_KEY_HISTORY);
                    return false; // Indicate load failed (error occurred)
                }
            };


            // Theme Persistence (localStorage - Updated Key)
            const saveTheme = (theme) => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY_THEME, theme);
                    console.log('Theme saved:', theme);
                } catch (e) {
                    console.error('Error saving theme to localStorage:', e);
                    announce('حدث خطأ في حفظ تفضيل الوضع الليلي/النهاري.'); // Translated
                }
            };

            const loadTheme = () => {
                try {
                    const savedTheme = localStorage.getItem(LOCAL_STORAGE_KEY_THEME);
                    console.log('Theme loaded:', savedTheme);
                    return savedTheme;
                } catch (e) {
                    console.error('Error loading theme from localStorage:', e);
                    announce('حدث خطأ في تحميل تفضيل الوضع الليلي/النهاري.'); // Translated
                    return null;
                }
            };


            // --- render.js (Updated for Representatives - Translated Texts) ---

            // Function to create a single representative card element (for the main selection grid)
            const createRepresentativeCard = (representative) => {
                const card = document.createElement('button');
                card.classList.add('representative-card'); // Updated class name
                card.dataset.key = representative.key;

                 const allTags = [...(representative.types || []), ...(representative.categories || [])];
                // Display tags nicely (e.g., "Religion: Islam", "Sect: Sunni") - Translate Prefixes
                const tagTranslations = {
                    'religion': 'الدين',
                    'sect': 'المذهب',
                    'denomination': 'الطائفة',
                    'philosophical': 'فلسفي',
                    'stance': 'موقف',
                    'movement': 'حركة',
                    'school': 'مدرسة',
                    'theology': 'عقيدة',
                    'fiqh': 'فقه',
                    'historical': 'تاريخي',
                    'public': 'عامة', // For public-aspects-only
                    'aspects': 'جوانب', // For public-aspects-only
                    'only': 'فقط', // For public-aspects-only
                    'general': 'عام', // For general category
                };

                const tagsHtml = allTags.map(tag => {
                    const parts = tag.split('-');
                    let translatedTag = tag; // Default to original tag

                    if (parts.length > 1) {
                         const prefix = parts[0].toLowerCase();
                         const valueParts = parts.slice(1).map(part => {
                              // Attempt to translate common values or keep as is
                              const commonValueTranslations = {
                                'islam': 'الإسلام',
                                'christianity': 'المسيحية',
                                'judaism': 'اليهودية',
                                'buddhism': 'البوذية',
                                'hinduism': 'الهندوسية',
                                'sunni': 'سني',
                                'shia': 'شيعي',
                                'ibadi': 'إباضي',
                                'orthodox': 'أرثوذكسية',
                                'catholic': 'كاثوليكية',
                                'protestant': 'بروتستانتية',
                                'atheism': 'إلحاد',
                                'agnosticism': 'لاأدرية',
                                'humanism': 'إنسانية',
                                'sufism': 'صوفية',
                                'quranist': 'قرآنيون',
                                'ashari': 'أشعرية',
                                'maturidi': 'ماتريدية',
                                'mutazila': 'معتزلة',
                                'hanafi': 'حنفي',
                                'maliki': 'مالكي',
                                'shafii': 'شافعي',
                                'hanbali': 'حنبلي',
                                'zahiri': 'ظاهري',
                                'jafari': 'جعفري',
                                'zaydi': 'زيدي',
                                // Add more specific translations if needed
                                'public': tagTranslations['public'],
                                'aspects': tagTranslations['aspects'],
                                'only': tagTranslations['only'],
                                'general': tagTranslations['general'],
                              };
                              return commonValueTranslations[part] || part.charAt(0).toUpperCase() + part.slice(1); // Capitalize if not translated
                         });

                         const translatedPrefix = tagTranslations[prefix] || prefix.charAt(0).toUpperCase() + prefix.slice(1); // Capitalize if not translated
                         translatedTag = `${translatedPrefix}: ${valueParts.join(' ')}`;

                    } else {
                         // Handle tags without prefix, e.g., 'general'
                         translatedTag = tagTranslations[tag] || tag.charAt(0).toUpperCase() + tag.slice(1); // Capitalize if not translated
                    }

                     return `<span class="tag">${translatedTag}</span>`;

                }).join('');


                card.innerHTML = `
                    <h3>${representative.name}</h3>
                    ${allTags.length > 0 ? `<div class="representative-tags">${tagsHtml}</div>` : ''}
                `;
                return card;
            };

            // Function to render the grid of representative cards (for the main selection view)
            const renderRepresentativeGrid = (representativesToDisplay) => {
                if (representativeGridDiv) {
                    representativeGridDiv.innerHTML = '';

                    let statusElement = document.getElementById('grid-status');
                    if (!statusElement) {
                        statusElement = createAriaStatusElement();
                        statusElement.id = 'grid-status';
                    }

                    if (representativesToDisplay.length === 0) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.classList.add('empty-grid-message');
                        emptyMessage.textContent = 'لا يوجد ممثلون يطابقون معاييرك.'; // Translated
                        representativeGridDiv.appendChild(emptyMessage);
                        statusElement.textContent = 'لا يوجد ممثلون يطابقون معاييرك.'; // Translated

                    } else {
                        const resultCount = representativesToDisplay.length;
                        const announcement = resultCount === 1 ? 'تم العثور على ممثل واحد.' : `تم العثور على ${resultCount} ممثلين.`; // Translated
                        statusElement.textContent = announcement;

                        representativesToDisplay.forEach(representative => {
                            const card = createRepresentativeCard(representative);
                            representativeGridDiv.appendChild(card);
                        });
                    }
                }
            };


            // --- Representative Management Rendering (Updated for Representatives - Translated Texts) ---

            // Function to create a single representative item for the management list
            const createManagementRepresentativeItem = (representative) => {
                const item = document.createElement('div');
                item.classList.add('management-representative-item');
                item.dataset.key = representative.key;

                // Display types and categories nicely (Translate Prefixes)
                const tagTranslations = {
                    'religion': 'الدين',
                    'sect': 'المذهب',
                    'denomination': 'الطائفة',
                    'philosophical': 'فلسفي',
                    'stance': 'موقف',
                    'movement': 'حركة',
                    'school': 'مدرسة',
                     'theology': 'عقيدة',
                    'fiqh': 'فقه',
                    'historical': 'تاريخي',
                    'public': 'عامة',
                    'aspects': 'جوانب',
                    'only': 'فقط',
                    'general': 'عام',
                };

                 const commonValueTranslations = {
                    'islam': 'الإسلام',
                    'christianity': 'المسيحية',
                    'judaism': 'اليهودية',
                    'buddhism': 'البوذية',
                    'hinduism': 'الهندوسية',
                    'sunni': 'سني',
                    'shia': 'شيعي',
                    'ibadi': 'إباضي',
                    'orthodox': 'أرثوذكسية',
                    'catholic': 'كاثوليكية',
                    'protestant': 'بروتستانتية',
                    'atheism': 'إلحاد',
                    'agnosticism': 'لاأدرية',
                    'humanism': 'إنسانية',
                    'sufism': 'صوفية',
                    'quranist': 'قرآنيون',
                    'ashari': 'أشعرية',
                    'maturidi': 'ماتريدية',
                    'mutazila': 'معتزلة',
                    'hanafi': 'حنفي',
                    'maliki': 'مالكي',
                    'shafii': 'شافعي',
                    'hanbali': 'حنبلية', // Corrected from Hanbali (Fiqh) to Hanbali (general, often used for Fiqh)
                    'zahiri': 'ظاهرية', // Corrected from Zahiri to الظاهرية (Fiqh)
                    'jafari': 'جعفرية', // Corrected from Jafari to الجعفرية (Fiqh)
                    'zaydi': 'زيدية', // Corrected from Zaydi to الزيدية (Shia sect)
                    // Add more specific translations if needed
                 };


                const formatTags = (tagArray) => {
                    return (tagArray || []).map(t => {
                        const parts = t.trim().split('-');
                        if (parts.length > 1) {
                            const prefix = parts[0].toLowerCase();
                            const valueParts = parts.slice(1).map(part => commonValueTranslations[part] || part.charAt(0).toUpperCase() + part.slice(1));
                             const translatedPrefix = tagTranslations[prefix] || prefix.charAt(0).toUpperCase() + prefix.slice(1);
                             return `${translatedPrefix}: ${valueParts.join(' ')}`;
                        }
                         return tagTranslations[t] || commonValueTranslations[t] || t.trim().replace(/\b\w/g, l => l.toUpperCase());
                    }).filter(t => t.length > 0).join(', ');
                };


                const types = formatTags(representative.types);
                const categories = formatTags(representative.categories);


                item.innerHTML = `
                    <h4>${representative.name}</h4>
                    <p><strong>المفتاح:</strong> ${representative.key}</p> <!-- Translated -->
                    ${types ? `<p><strong>الأنواع:</strong> ${types}</p>` : ''} <!-- Translated -->
                    ${categories ? `<p><strong>الفئات:</strong> ${categories}</p>` : ''} <!-- Translated -->
                    <p class="instruction-preview">${representative.instruction.substring(0, 100)}${representative.instruction.length > 100 ? '...' : ''}</p>
                    <div class="item-actions">
                        <button class="edit-representative-button" data-key="${representative.key}" aria-label="تعديل ${representative.name}">تعديل</button> <!-- Translated -->
                        <button class="delete-representative-button" data-key="${representative.key}" aria-label="حذف ${representative.name}">حذف</button> <!-- Translated -->
                    </div>
                `;
                return item;
            };

            // Function to render the list of representatives in the management view
            const renderRepresentativeManagementList = (representativesToDisplay) => {
                if (representativeManagementList) {
                    representativeManagementList.innerHTML = '';

                    if (representativesToDisplay.length === 0) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.classList.add('empty-list-message');
                        emptyMessage.textContent = 'لم تتم إضافة ممثلين بعد.'; // Translated
                        representativeManagementList.appendChild(emptyMessage);
                    } else {
                        representativesToDisplay.forEach(representative => {
                            const item = createManagementRepresentativeItem(representative);
                            representativeManagementList.appendChild(item);
                        });
                    }
                }
            };

            // Function to show the representative form modal (for add/edit)
            const showRepresentativeForm = (representative = null) => {
                if (representativeFormModal && representativeForm && representativeFormTitle && formRepresentativeKey && formRepresentativeName && formRepresentativeInstruction && formRepresentativeTypes && formRepresentativeCategories) { // Updated IDs
                    if (representative) {
                        representativeFormTitle.textContent = `تعديل الممثل: ${representative.name}`; // Translated text
                        formRepresentativeKey.value = representative.key;
                        formRepresentativeName.value = representative.name;
                        formRepresentativeInstruction.value = representative.instruction;
                        formRepresentativeTypes.value = (representative.types || []).join(', ');
                        formRepresentativeCategories.value = (representative.categories || []).join(', ');

                    } else {
                        representativeFormTitle.textContent = 'إضافة ممثل جديد'; // Translated text
                        formRepresentativeKey.value = '';
                        representativeForm.reset();
                    }

                    representativeFormModal.classList.remove('hidden');
                    representativeFormModal.setAttribute('aria-hidden', 'false');
                    formRepresentativeName.focus();
                } else {
                    console.error("Failed to show representative form: Missing DOM elements."); // Updated text
                    announce("خطأ في عرض نموذج الممثل."); // Translated
                }
            };

            // Function to hide the representative form modal
            const hideRepresentativeForm = () => {
                if (representativeFormModal && representativeForm && formRepresentativeKey) {
                    representativeFormModal.classList.add('hidden');
                    representativeFormModal.setAttribute('aria-hidden', 'true');
                    representativeForm.reset();
                    formRepresentativeKey.value = '';
                } else {
                    console.error("Failed to hide representative form: Missing DOM elements."); // Updated text
                }
            };


            // --- Chat Rendering (Minor Updates - Translated Text) ---

            const displayUserMessage = (text) => {
                if (chatbox) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'user-message');
                    messageElement.textContent = text;
                    chatbox.appendChild(messageElement);
                }
            };

            const displayBotMessage = (text, isTypingIndicator = false) => {
                if (chatbox) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'bot-message');

                    if (isTypingIndicator) {
                        messageElement.classList.add('typing');
                        messageElement.innerHTML = '<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>';
                        messageElement.setAttribute('aria-label', 'الذكاء الاصطناعي يكتب...'); // Translated
                        messageElement.setAttribute('role', 'status');
                        messageElement.setAttribute('aria-live', 'polite');
                    } else {
                        messageElement.textContent = text;
                        messageElement.removeAttribute('aria-label');
                        messageElement.removeAttribute('role');
                        messageElement.removeAttribute('aria-live');
                    }
                    chatbox.appendChild(messageElement);
                    return messageElement;
                }
                return null;
            };

            const scrollToBottom = () => {
                if (chatbox) {
                    setTimeout(() => {
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }, 50);
                }
            };

            const renderChatHistory = (history) => {
                if (chatbox && appState.selectedRepresentative) { // Updated state property
                    chatbox.innerHTML = '';
                    if (history.length === 0) {
                        // Updated initial message (Translated)
                        displayBotMessage(`أنت تتحدث الآن عن المعتقدات مع ممثل عن ${appState.selectedRepresentative.name}. لا تتردد في طرح أسئلة حول وجهة نظرهم.`, false);
                    } else {
                        history.forEach(message => {
                            if (message.role === 'user') {
                                displayUserMessage(message.parts[0].text);
                            } else if (message.role === 'model') {
                                displayBotMessage(message.parts[0].text, false);
                            }
                        });
                    }
                    scrollToBottom();
                }
            };

            const updateFilterCheckboxes = () => {
                if (filterCheckboxes) {
                    filterCheckboxes.forEach(checkbox => {
                        const isSelected = appState.selectedFilters.includes(checkbox.value);
                        checkbox.checked = isSelected;
                        const label = document.querySelector(`label[for="${checkbox.id}"]`);
                        if (label) {
                            label.setAttribute('aria-selected', isSelected ? 'true' : 'false');
                        }
                    });
                }
                const allCheckbox = document.getElementById('filter-all');
                const allLabel = document.querySelector('label[for="filter-all"]');
                if (allCheckbox && allLabel) {
                    allLabel.setAttribute('aria-selected', allCheckbox.checked ? 'true' : 'false');
                }
            };

            const applyTheme = (theme) => {
                const body = document.body;
                const darkModeToggle = document.getElementById('dark-mode-toggle');

                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    if (darkModeToggle) darkModeToggle.setAttribute('aria-label', 'تبديل الوضع النهاري'); // Translated
                } else {
                    body.classList.remove('dark-mode');
                    if (darkModeToggle) darkModeToggle.setAttribute('aria-label', 'تبديل الوضع الليلي'); // Translated
                }
            };


            // --- filtering.js (Updated for Representatives) ---
            const filterAndRenderRepresentatives = () => {
                if (appState.currentState !== 'representative-selection') {
                    renderRepresentativeGrid([]);
                    return;
                }

                const representativesToFilter = appState.allRepresentativesMutable;

                const searchTerm = appState.currentSearchTerm.toLowerCase();

                const filtered = representativesToFilter.filter(representative => {
                    const representativeTags = [...(representative.types || []), ...(representative.categories || [])];

                    let passesFilter = false;
                    if (appState.selectedFilters.includes('all') || appState.selectedFilters.length === 0) {
                        passesFilter = true;
                    } else {
                        passesFilter = appState.selectedFilters.every(filterValue => {
                            return representativeTags.includes(filterValue);
                        });
                    }

                    // Search term matches name (translated or not) or tags (english id)
                    const searchTermMatch = representative.name.toLowerCase().includes(searchTerm) || representativeTags.some(tag => tag.toLowerCase().includes(searchTerm));

                    return passesFilter && searchTermMatch;
                });

                renderRepresentativeGrid(filtered);
            };

            const handleFilterChange = (event) => {
                 if (appState.currentState !== 'representative-selection') {
                    console.warn("Attempted to change filters while not on representative selection view.");
                     if (event.target && event.target.type === 'checkbox') {
                         // Revert checkbox state if click occurred in the wrong view
                         event.target.checked = !event.target.checked;
                     }
                    return;
                }

                if (event.target && event.target.type === 'checkbox') {
                    const clickedValue = event.target.value;
                    const isChecked = event.target.checked;

                    let tempSelectedFilters = [];
                    if (filterCheckboxes) {
                        filterCheckboxes.forEach(checkbox => {
                            if (checkbox.checked) {
                                tempSelectedFilters.push(checkbox.value);
                            }
                        });
                    }

                    if (clickedValue === 'all') {
                        if (isChecked) {
                            tempSelectedFilters = ['all'];
                            if (filterCheckboxes) {
                                filterCheckboxes.forEach(checkbox => {
                                    checkbox.checked = (checkbox.value === 'all');
                                });
                            }
                        } else {
                            // If 'all' is unchecked, and it's the only filter, keep it checked
                             if (appState.selectedFilters.length === 1 && appState.selectedFilters.includes('all')) {
                                // Do nothing, keep 'all' checked
                                if (event.target) event.target.checked = true; // Revert the click
                                announce('لا يمكنك إلغاء تحديد "الكل" عندما لا توجد فلاتر أخرى مختارة.'); // Translated
                                return;
                             }
                            tempSelectedFilters = tempSelectedFilters.filter(val => val !== 'all');
                        }
                    } else { // Handling non-'all' checkboxes
                         if (isChecked) {
                             // If a specific filter is checked, uncheck 'all' if it's currently selected
                            if (appState.selectedFilters.includes('all')) {
                                tempSelectedFilters = tempSelectedFilters.filter(val => val !== 'all');
                                 const allCheckbox = document.getElementById('filter-all');
                                if (allCheckbox) allCheckbox.checked = false;
                             }
                             if (!tempSelectedFilters.includes(clickedValue)) {
                                 tempSelectedFilters.push(clickedValue);
                             }
                         } else {
                             // If a specific filter is unchecked
                            tempSelectedFilters = tempSelectedFilters.filter(val => val !== clickedValue);
                             // If no other filters are selected after unchecking, automatically select 'all'
                            if (tempSelectedFilters.length === 0) {
                                 tempSelectedFilters = ['all'];
                                 const allCheckbox = document.getElementById('filter-all');
                                if (allCheckbox) allCheckbox.checked = true;
                             }
                         }
                    }

                    appState.selectedFilters = tempSelectedFilters;
                    updateFilterCheckboxes();

                    console.log("Selected filters:", appState.selectedFilters);
                    filterAndRenderRepresentatives();

                    const label = document.querySelector(`label[for="${event.target.id}"]`);
                    if (label) {
                        announce(`تم تحديد الفلتر ${label.textContent}: ${isChecked ? 'مفعل' : 'معطل'}.`); // Translated
                    }

                    saveState();
                }
            };


            const handleSearchInput = (event) => {
                if (appState.currentState !== 'representative-selection') { // Updated state name
                    console.warn("Attempted to search while not on representative selection view."); // Updated text
                    if (event.target) event.target.value = '';
                    return;
                }
                if (event.target) appState.currentSearchTerm = event.target.value;
                filterAndRenderRepresentatives(); // Updated function call
            };


            // --- representativeManagement.js (Updated for Representatives) ---

            const generateRepresentativeKey = (name) => { // Renamed function
                // Use a basic slug from name, but ensure it's safe and unique enough
                // Since names are now Arabic, a simple timestamp+random might be safer/easier
                 const safeNamePart = name.replace(/\s+/g, '-').replace(/[^\u0600-\u06FFa-zA-Z0-9-]/g, '').substring(0, 20); // Allow Arabic letters
                 const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 8);

                return `${safeNamePart || 'rep'}-${timestamp}-${random}`;
            };

            const saveRepresentative = (formData) => {
                const { key, name, instruction, types, categories } = formData;

                if (!name || name.trim() === '' || !instruction || instruction.trim() === '') {
                    announce('الاسم والتعليمات مطلوبان.'); // Translated
                    return false;
                }

                const typesArray = types ? types.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
                const categoriesArray = categories ? categories.split(',').map(c => c.trim()).filter(c => c.length > 0) : [];

                let representativeIndex = -1;
                if (key && key !== '') {
                    representativeIndex = appState.allRepresentativesMutable.findIndex(r => r.key === key);
                }

                if (representativeIndex > -1) {
                    appState.allRepresentativesMutable[representativeIndex] = {
                        key: key,
                        name: name.trim(),
                        instruction: instruction.trim(),
                        types: typesArray,
                        categories: categoriesArray
                    };
                    console.log('Representative updated:', name);
                    announce(`تم تحديث الممثل "${name.trim()}".`); // Translated
                } else {
                    const newRepresentative = {
                        key: generateRepresentativeKey(name.trim()),
                        name: name.trim(),
                        instruction: instruction.trim(),
                        types: typesArray,
                        categories: categoriesArray
                    };
                    appState.allRepresentativesMutable.push(newRepresentative);
                    console.log('Representative added:', name);
                    announce(`تمت إضافة الممثل "${name.trim()}".`); // Translated
                }

                saveRepresentatives();
                renderRepresentativeManagementList(appState.allRepresentativesMutable);
                filterAndRenderRepresentatives();

                return true;
            };

            const deleteRepresentative = (key) => {
                if (!key || key.trim() === '') {
                    console.error("No valid key provided for deletion.");
                    announce("خطأ: لم يتم حذف الممثل."); // Translated
                    return;
                }

                const representativeToDelete = appState.allRepresentativesMutable.find(r => r.key === key);
                const representativeName = representativeToDelete ? representativeToDelete.name : 'غير معروف'; // Translated

                const initialCount = appState.allRepresentativesMutable.length;
                appState.allRepresentativesMutable = appState.allRepresentativesMutable.filter(representative => representative.key !== key);
                const newCount = appState.allRepresentativesMutable.length;

                if (newCount < initialCount) {
                    console.log('Representative deleted:', key);
                    announce(`تم حذف الممثل "${representativeName}".`); // Translated

                    saveRepresentatives();

                    if (appState.selectedRepresentative && appState.selectedRepresentative.key === key) {
                        console.log(`Deleted active representative "${representativeName}". Clearing chat state and going back.`);
                        goBackToRepresentatives();
                    } else {
                        renderRepresentativeManagementList(appState.allRepresentativesMutable);
                        filterAndRenderRepresentatives();
                    }
                } else {
                    console.warn('Representative not found for deletion:', key);
                    announce(`الممثل "${representativeName}" غير موجود للحذف.`); // Translated
                }
            };

            const getRepresentativeByKey = (key) => {
                if (!key || key.trim() === '') {
                    console.error("No valid key provided for lookup.");
                    return undefined;
                }
                return appState.allRepresentativesMutable.find(representative => representative.key === key);
            };


            // --- api.js (Instructions are now Arabic) ---
            const sendMessageToAPI = async (representativeInstruction, history, message) => {
                // Combine global, negative, and specific instructions (all in Arabic now)
                const finalInstruction = `${GLOBAL_INSTRUCTION}\n\n${representativeInstruction}\n\n${NEGATIVE_INSTRUCTION}`; // All parts are Arabic strings

                const contents = history.map(msg => ({
                    role: msg.role,
                    parts: msg.parts
                }));
                contents.push({ role: 'user', parts: [{ text: message }] });

                if (GOOGLE_API_KEY === '' || GOOGLE_API_KEY.length < 20 || GOOGLE_API_KEY.startsWith('YOUR')) {
                    console.error("API Key is not configured correctly. Cannot send message.");
                    throw new Error("API Key Error: Chat functionality is not properly configured.");
                }

                const apiRequestBody = {
                    contents: contents,
                    systemInstruction: {
                        parts: [{ text: finalInstruction }] // Use the combined instruction (Arabic)
                    },
                    generationConfig: {
                        temperature: 0.7, // Adjust temperature for desired creativity/faithfulness (lower might be better for factual explanation)
                        topP: 0.95,
                        topK: 40
                    }
                };

                const apiResponse = await fetch(`${API_BASE_URL}?key=${GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(apiRequestBody),
                });

                if (!apiResponse.ok) {
                    const errorBody = await apiResponse.json().catch(() => ({ error: { message: 'Unknown API Error' } }));
                    const errorMessage = errorBody.error?.message || apiResponse.statusText;
                    console.error(`API Error: ${apiResponse.status} - ${errorMessage}`, errorBody);
                    throw new Error(`API Error: ${apiResponse.status} - ${errorMessage}`);
                }

                const apiData = await apiResponse.json();
                return apiData;
            };

            // --- core.js (Updated for Representatives - Translated Texts) ---
            const sendMessage = async () => {
                const messageText = userInput.value.trim();

                if (appState.currentState !== 'chat' || !messageText || !appState.selectedRepresentative || (userInput && userInput.disabled)) {
                    console.warn("Attempted to send message when not allowed.");
                    return;
                }

                if (userInput) userInput.disabled = true;
                if (sendButton) sendButton.disabled = true;

                displayUserMessage(messageText);
                if (userInput) userInput.value = '';
                scrollToBottom();

                appState.conversationHistory.push({ role: 'user', parts: [{ text: messageText }] });
                saveActiveChatState();

                let typingIndicator = null;
                try {
                    typingIndicator = displayBotMessage("...", true); // This is a visual indicator, text is just "..."
                    scrollToBottom();

                    // Pass the specific representative's instruction (now in Arabic) to the API call
                    const apiData = await sendMessageToAPI(appState.selectedRepresentative.instruction, appState.conversationHistory, messageText);

                    if (typingIndicator && chatbox && typingIndicator.parentElement) {
                        chatbox.removeChild(typingIndicator);
                    }

                    let botResponseText = '';

                    if (apiData.candidates && apiData.candidates[0]) {
                        if (apiData.candidates[0].finishReason === 'SAFETY') {
                            console.warn('API response blocked due to safety settings:', apiData.candidates[0].safetyRatings);
                            // Remove the user's last message from history if it was blocked
                            if (appState.conversationHistory.length > 0 && appState.conversationHistory[appState.conversationHistory.length - 1].role === 'user') {
                                appState.conversationHistory.pop();
                            }
                            saveActiveChatState(); // Save updated history

                            // Provide a generic safety message (Translated)
                            botResponseText = `[مُمثّل ${appState.selectedRepresentative.name}]: لا أستطيع الرد على هذا الاستفسار لأنه ينتهك إرشادات السلامة. يرجى السؤال عن المعتقدات أو إعادة صياغة سؤالك.`;
                            displayBotMessage(botResponseText, false);
                            announce("تم حظر استجابة الذكاء الاصطناعي بسبب إرشادات السلامة."); // Translated
                        } else if (apiData.candidates[0].content && apiData.candidates[0].content.parts && apiData.candidates[0].content.parts[0] && apiData.candidates[0].content.parts[0].text) {
                            botResponseText = apiData.candidates[0].content.parts[0].text;
                            // Ensure the last history entry is the user message before pushing the model response
                            if (appState.conversationHistory.length > 0 && appState.conversationHistory[appState.conversationHistory.length - 1].role === 'user') {
                                appState.conversationHistory.push({ role: 'model', parts: [{ text: botResponseText }] });
                                displayBotMessage(botResponseText, false);
                                announce(`رد الممثل عن ${appState.selectedRepresentative.name}: ${botResponseText.substring(0, Math.min(botResponseText.length, 100))}...`); // Translated
                                saveActiveChatState(); // Save updated history

                            } else {
                                console.error("History state mismatch: Expected last message to be user before adding model response.");
                                displayBotMessage('حدث خطأ داخلي أثناء معالجة سجل المحادثة.', false); // Translated
                                announce('حدث خطأ داخلي.'); // Translated
                            }

                        } else {
                            console.warn('API response received, but no text content found:', apiData);
                            // Remove the user's last message from history if response was empty/invalid
                            if (appState.conversationHistory.length > 0 && appState.conversationHistory[appState.conversationHistory.length - 1].role === 'user') {
                                appState.conversationHistory.pop();
                            }
                            saveActiveChatState(); // Save updated history

                            botResponseText = 'تلقيت استجابة غير صالحة أو فارغة من الذكاء الاصطناعي.'; // Translated
                            displayBotMessage(botResponseText, false);
                            announce('تلقيت استجابة غير صالحة أو فارغة من الذكاء الاصطناعي.'); // Translated
                        }
                    } else {
                        console.error('Unexpected API response structure or empty candidates:', apiData);
                        // Remove the user's last message from history if response was empty/invalid
                        if (appState.conversationHistory.length > 0 && appState.conversationHistory[appState.conversationHistory.length - 1].role === 'user') {
                            appState.conversationHistory.pop();
                        }
                        saveActiveChatState(); // Save updated history


                        botResponseText = 'خطأ: لم يتم الحصول على استجابة صالحة من الذكاء الاصطناعي.'; // Translated
                        displayBotMessage(botResponseText, false);
                        announce('خطأ: لم يتم الحصول على استجابة صالحة من الذكاء الاصطناعي.'); // Translated
                    }

                    scrollToBottom();

                } catch (error) {
                    console.error('Error during chat message processing:', error);
                    if (typingIndicator && chatbox && typingIndicator.parentElement) {
                        chatbox.removeChild(typingIndicator);
                    }
                    // Remove the user's last message from history on API error
                    if (appState.conversationHistory.length > 0 && appState.conversationHistory[appState.conversationHistory.length - 1].role === 'user') {
                        appState.conversationHistory.pop();
                    }
                    saveActiveChatState(); // Save updated history


                    displayBotMessage(`خطأ: ${error.message || 'فشل الحصول على استجابة من الذكاء الاصطناعي.'}`, false); // Translated
                    scrollToBottom();
                    announce(`خطأ: ${error.message || 'فشل الحصول على استجابة من الذكاء الاصطناعي.'}`); // Translated

                } finally {
                    const isApiKeyValid = GOOGLE_API_KEY !== '' && GOOGLE_API_KEY.length >= 20 && !GOOGLE_API_KEY.startsWith('YOUR');
                    if (appState.currentState === 'chat' && isApiKeyValid) {
                        if (userInput) userInput.disabled = false;
                        if (sendButton) sendButton.disabled = false;
                        if (userInput) userInput.focus();
                    } else if (appState.currentState === 'chat') {
                        console.warn("Chat input remains disabled after API call due to missing/invalid API key.");
                        // Keep disabled if API key is bad
                        if (userInput) userInput.disabled = true;
                        if (sendButton) sendButton.disabled = true;
                    }
                }
            };

            // --- viewManager.js (Updated for Representatives - Translated Texts) ---
            const showView = (viewName) => {
                const validViews = ['representative-selection', 'chat', 'representative-management'];
                if (!validViews.includes(viewName)) {
                    console.error(`Invalid view name: ${viewName}. Must be one of ${validViews.join(', ')}.`);
                    return;
                }

                appState.currentState = viewName;
                console.log(`Showing view: ${viewName}`);

                const viewsInsideMain = mainAppContentDiv ? mainAppContentDiv.querySelectorAll('.view') : [];
                viewsInsideMain.forEach(view => {
                    let targetViewElement = null;
                    if (viewName === 'chat') targetViewElement = chatContainerDiv;
                    else if (viewName === 'representative-selection') targetViewElement = representativeSelectionDiv;
                    else if (viewName === 'representative-management') targetViewElement = representativeManagementDiv;

                    if (view === targetViewElement) {
                        view.classList.remove('hidden');
                        view.setAttribute('aria-hidden', 'false');
                    } else {
                        view.classList.add('hidden');
                        view.setAttribute('aria-hidden', 'true');
                    }
                });

                if (viewName === 'representative-selection') {
                    if (userInput) userInput.disabled = true;
                    if (sendButton) sendButton.disabled = true;
                    if (chatbox) chatbox.innerHTML = '';
                    appState.selectedRepresentative = null;
                    appState.conversationHistory = [];

                    filterAndRenderRepresentatives();

                    setTimeout(() => {
                        const representativeSearchInput = document.getElementById('representative-search');
                        if (representativeSearchInput) representativeSearchInput.focus();
                    }, 100);

                } else if (viewName === 'chat') {
                    renderChatHistory(appState.conversationHistory);

                    const isApiKeyValid = GOOGLE_API_KEY !== '' && GOOGLE_API_KEY.length >= 20 && !GOOGLE_API_KEY.startsWith('YOUR');
                    if (isApiKeyValid) {
                        if (userInput) userInput.disabled = false;
                        if (sendButton) sendButton.disabled = false;
                        if (userInput) userInput.focus();
                    } else {
                        console.warn("Chat input disabled due to missing/invalid API key.");
                        if (userInput) userInput.disabled = true;
                        if (sendButton) sendButton.disabled = true; // Ensure send button is also disabled
                         if (chatbox && chatbox.children.length <= 1) { // Only show if not already showing initial API key error message
                             // Check if the last message is NOT the API key error
                             const lastMessage = chatbox.lastElementChild;
                             const isAlreadyShowingError = lastMessage && lastMessage.classList.contains('bot-message') && lastMessage.textContent.includes('API Key');

                             if (!isAlreadyShowingError) {
                                displayBotMessage("مفتاح API غير مُعدّ. وظيفة الدردشة معطلة.", false); // Translated
                             }
                        }
                    }
                    scrollToBottom();

                } else if (viewName === 'representative-management') {
                    renderRepresentativeManagementList(appState.allRepresentativesMutable);

                    if (userInput) userInput.disabled = true;
                    if (sendButton) sendButton.disabled = true;
                    if (chatbox) chatbox.innerHTML = '';
                    appState.selectedRepresentative = null;
                    appState.conversationHistory = [];

                    setTimeout(() => {
                        const addRepresentativeButton = document.getElementById('add-representative-button');
                        if (addRepresentativeButton) addRepresentativeButton.focus();
                    }, 100);
                }
            };

            const startChat = (representative) => {
                if (appState.currentState !== 'representative-selection') {
                    console.warn("Attempted to select representative while not on selection view.");
                    return;
                }

                if (!representative) {
                    console.error("No representative provided to startChat.");
                    return;
                }

                saveActiveChatState(); // Save state before switching

                appState.selectedRepresentative = representative;
                appState.conversationHistory = []; // Start new chat history

                saveActiveChatState(); // Save new empty chat state

                if (currentRepresentativeSpan) currentRepresentativeSpan.textContent = representative.name;

                showView('chat');

                announce(`بدأت المحادثة مع ممثل عن ${representative.name}.`); // Translated
            };

            const goBackToRepresentatives = () => {
                if (appState.currentState === 'representative-selection') {
                    console.warn("Already on representative selection view.");
                    return;
                }

                saveActiveChatState(); // Save chat state before leaving

                showView('representative-selection');

                announce('عادت إلى شاشة اختيار الممثلين.'); // Translated
            };

            const showRepresentativeManagementView = () => {
                if (appState.currentState !== 'representative-selection') {
                    console.warn("Attempted to go to management while not on selection view.");
                    return;
                }

                saveActiveChatState(); // Save chat state before leaving

                showView('representative-management');

                announce('عرض شاشة إدارة الممثلين.'); // Translated
            }

            const clearChatHistory = () => {
                if (appState.currentState !== 'chat') {
                    console.warn("Attempted to clear chat history while not in chat view.");
                    announce("لا يمكن مسح سجل المحادثة الآن."); // Translated
                    return;
                }

                if (!appState.selectedRepresentative) return;

                appState.conversationHistory = [];
                saveActiveChatState();

                renderChatHistory(appState.conversationHistory);

                console.log('Chat history cleared.');

                const isApiKeyValid = GOOGLE_API_KEY !== '' && GOOGLE_API_KEY.length >= 20 && !GOOGLE_API_KEY.startsWith('YOUR');
                if (userInput && !userInput.disabled && isApiKeyValid) {
                    userInput.focus();
                }

                announce('تم مسح سجل المحادثة.'); // Translated
            };


            // --- representativeManagementUi.js (Updated for Representatives - Translated Texts) ---

            const setupRepresentativeManagementListeners = () => {
                if (addRepresentativeButton) {
                    addRepresentativeButton.addEventListener('click', () => {
                        showRepresentativeForm();
                    });
                }

                if (backFromManagementButton) {
                    backFromManagementButton.addEventListener('click', () => {
                        goBackToRepresentatives();
                    });
                }

                if (representativeManagementList) {
                    representativeManagementList.addEventListener('click', (event) => {
                        const editButton = event.target.closest('.edit-representative-button');
                        const deleteButton = event.target.closest('.delete-representative-button');

                        if (editButton) {
                            const key = editButton.dataset.key;
                            const representativeToEdit = getRepresentativeByKey(key);
                            if (representativeToEdit) {
                                showRepresentativeForm(representativeToEdit);
                            } else {
                                announce(`خطأ: الممثل بالمفتاح ${key} غير موجود.`); // Translated
                            }
                        } else if (deleteButton) {
                            const key = deleteButton.dataset.key;
                            if (confirm('هل أنت متأكد أنك تريد حذف هذا الممثل؟')) { // Translated confirm prompt
                                deleteRepresentative(key);
                            }
                        }
                    });
                }

                if (representativeForm) {
                    representativeForm.addEventListener('submit', (event) => {
                        event.preventDefault();

                        const formData = {
                            key: formRepresentativeKey ? formRepresentativeKey.value : '',
                            name: formRepresentativeName ? formRepresentativeName.value.trim() : '',
                            instruction: formRepresentativeInstruction ? formRepresentativeInstruction.value.trim() : '',
                            types: formRepresentativeTypes ? formRepresentativeTypes.value.trim() : '',
                            categories: formRepresentativeCategories ? formRepresentativeCategories.value.trim() : ''
                        };

                        const success = saveRepresentative(formData);

                        if (success) {
                            hideRepresentativeForm();
                        }
                    });
                }

                if (cancelFormButton) {
                    cancelFormButton.addEventListener('click', hideRepresentativeForm);
                }

                if (representativeFormModal) {
                    representativeFormModal.addEventListener('click', (event) => {
                        // Close modal if clicking outside the modal content
                        if (event.target === representativeFormModal) {
                            hideRepresentativeForm();
                        }
                    });
                }
            };


            // --- Main Application Logic ---

            // Ensure ARIA status element is created early
            createAriaStatusElement();

            // Load theme preference immediately
            const savedTheme = loadTheme();
            applyTheme(savedTheme || 'light');

            // Load representatives from storage (or defaults)
            loadRepresentatives();

            // Load other general state (filters)
            loadState();

            // Update filter checkboxes visually based on loaded state
            updateFilterCheckboxes();

            // Attempt to load active chat state. If successful, go to chat; otherwise, go to representative selection
            const chatLoaded = loadActiveChatState();

            if (chatLoaded) {
                // Set the correct representative name in the header if a chat was loaded
                if (appState.selectedRepresentative && currentRepresentativeSpan) {
                    currentRepresentativeSpan.textContent = appState.selectedRepresentative.name;
                }
                showView('chat');
            } else {
                showView('representative-selection');
            }


            // --- Event Listeners ---

            // Dark Mode Toggle
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    applyTheme(newTheme);
                    saveTheme(newTheme);
                     announce(`تم تبديل الوضع إلى ${newTheme === 'dark' ? 'الليلي' : 'النهاري'}.`); // Translated
                });
            }

            // Representative Filtering & Search Listeners
            const filterOptionsDiv = document.querySelector('#representative-filters .filter-options');
            if (filterOptionsDiv) {
                filterOptionsDiv.addEventListener('change', handleFilterChange);
            }
            if (representativeSearchInput) representativeSearchInput.addEventListener('input', handleSearchInput);

            // Representative Card Click Listener (using delegation on the grid)
            if (representativeGridDiv) {
                representativeGridDiv.addEventListener('click', (event) => {
                    if (appState.currentState !== 'representative-selection') {
                        console.warn("Attempted to select representative while not on selection view.");
                        return;
                    }
                    const clickedCard = event.target.closest('.representative-card');
                    if (clickedCard && !clickedCard.disabled) {
                        const representativeKey = clickedCard.dataset.key;
                        const representativeObject = appState.allRepresentativesMutable.find(r => r.key === representativeKey);
                        if (representativeObject) {
                            startChat(representativeObject);
                        } else {
                            console.warn(`Clicked representative with key ${representativeKey} not found in mutable list.`);
                             announce(`الممثل المحدد غير موجود.`); // Translated
                        }
                    }
                });
            }

            // Chat Input Listeners
            if (sendButton) sendButton.addEventListener('click', sendMessage);
            if (userInput) {
                userInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) { // Allow Shift+Enter for new line
                        event.preventDefault();
                        if (appState.currentState === 'chat' && !userInput.disabled) {
                            sendMessage();
                        }
                    }
                });
                // Auto-resize textarea
                userInput.addEventListener('input', () => {
                    userInput.style.height = 'auto';
                    userInput.style.height = (userInput.scrollHeight) + 'px';
                });
            }


            // Chat Header Button Listeners

            if (backToRepresentativesButton) {
                backToRepresentativesButton.addEventListener('click', goBackToRepresentatives);
            }
            if (clearChatButton) {
                clearChatButton.addEventListener('click', clearChatHistory);
            }

            // Representative Management Button Listener
            if (manageRepresentativesButton) {
                manageRepresentativesButton.addEventListener('click', showRepresentativeManagementView);
            }

            // Setup Listeners specific to the Representative Management View and Form
            setupRepresentativeManagementListeners();
        });
    </script>
</body>

</html> 